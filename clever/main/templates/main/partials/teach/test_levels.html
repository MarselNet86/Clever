<div id="testLevelsContent" class="hidden w-full max-w-[1600px] mx-auto pb-20 px-4">
    <!-- –ì–ª–∞–≤–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div class="bg-white rounded-[2.5rem] shadow-2xl shadow-gray-200/50 border border-gray-100 p-8 md:p-12">
        
        <!-- Header —Å–µ–∫—Ü–∏–∏ -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-12">
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 bg-brand-green/10 rounded-[1.5rem] flex items-center justify-center shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-brand-green" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5h6M9 9h6M9 13h6M9 17h6M5 5h.01M5 9h.01M5 13h.01M5 17h.01" />
                    </svg>
                </div>
                <div>
                    <h2 class="text-3xl font-black text-brand-green-dark tracking-tight">–ü–æ—Ä–æ–≥–∏ –æ—Ü–µ–Ω–æ–∫</h2>
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mt-1">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Ç–∑—ã–≤–æ–≤ –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –±–∞–ª–ª–æ–≤</p>
                </div>
            </div>
        </div>

        {% if my_tests %}
        <div class="grid grid-cols-1 gap-8">
            {% for t in my_tests %}
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–µ—Å—Ç–∞ –≤ —Å–ø–∏—Å–∫–µ —É—Ä–æ–≤–Ω–µ–π -->
            <div class="group bg-gray-50/50 rounded-[2rem] border border-gray-100 p-6 md:p-8 transition-all hover:bg-white hover:shadow-xl">
                <div class="flex flex-wrap justify-between items-center gap-6">
                    <div class="flex-1 min-w-[250px]">
                        <div class="flex items-center gap-3 mb-2">
                            <h3 class="text-xl font-black text-gray-800 leading-tight">{{ t.title }}</h3>
                            <div class="px-3 py-1 rounded-lg text-[9px] font-black border border-brand-green/20 text-brand-green bg-brand-green/5 uppercase tracking-wider">
                                {{ t.questions.count }} –≤–æ–ø—Ä–æ—Å–æ–≤
                            </div>
                        </div>
                        <p class="text-sm font-medium text-gray-400 italic">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ, —á—Ç–æ —É–≤–∏–¥–∏—Ç —É—á–µ–Ω–∏–∫ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–∞–∑–Ω—ã—Ö –±–∞–ª–ª–æ–≤</p>
                    </div>

                    <button type="button"
                        class="px-8 py-4 bg-brand-green hover:bg-brand-green-hover text-white font-black rounded-[1.2rem] transition-all shadow-lg shadow-brand-green/10 flex items-center gap-3 active:scale-95 text-xs uppercase tracking-widest"
                        onclick="toggleLevelsForm({{ t.id }})">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                        </svg>
                        –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
                    </button>
                </div>

                <!-- Accordion: –§–æ—Ä–º–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
                <div id="levelsForm_{{ t.id }}" class="grid grid-rows-[0fr] transition-all duration-500 ease-in-out">
                    <div class="overflow-hidden">
                        <div class="my-10 h-px bg-gray-100"></div>

                        <form method="post" action="{% url 'main:test_levels' t.id %}" class="space-y-10 pb-4">
                            {% csrf_token %}
                            <input type="hidden" name="levels_count" value="3" />

                            <!-- –°–µ—Ç–∫–∞ —É—Ä–æ–≤–Ω–µ–π -->
                            <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">

                                <!-- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–∞–∫—Ä–æ—Å –¥–ª—è —É—Ä–æ–≤–Ω–µ–π -->
                                {% for i in "123" %}
                                <div class="bg-white border border-gray-100 rounded-[2rem] p-6 shadow-sm relative overflow-hidden group/lvl">
                                    <div class="flex justify-between items-center mb-8">
                                        <span class="px-3 py-1 rounded-lg text-[10px] font-black text-white 
                                            {% if i == '1' %}bg-red-500 shadow-red-100{% elif i == '2' %}bg-yellow-500 shadow-yellow-100{% else %}bg-brand-green shadow-brand-green/20{% endif %} shadow-lg uppercase tracking-widest">
                                            –£—Ä–æ–≤–µ–Ω—å {{ i }}
                                        </span>

                                        <div class="text-brand-green font-black text-xs tracking-tighter bg-brand-green/5 px-3 py-1 rounded-lg">
                                            <span data-min-label="{{ i }}">
                                                {% if i == '1' %}0{% elif i == '2' %}31{% else %}60{% endif %}
                                            </span>% ‚Äî 
                                            <span data-max-label="{{ i }}">
                                                {% for lvl in t.levels.all %}{% if lvl.order|stringformat:"i" == i %}{{ lvl.max_percent }}{% endif %}{% endfor %}
                                                {% if not t.levels.all %}{% if i == '1' %}30{% elif i == '2' %}59{% else %}100{% endif %}{% endif %}
                                            </span>%
                                        </div>
                                    </div>

                                    <div class="space-y-6">
                                        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —É—Ä–æ–≤–Ω—è -->
                                        <div class="form-control">
                                            <label class="block text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2 ml-1">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
                                            <input name="level_{{ i }}_title" required
                                                value="{% for lvl in t.levels.all %}{% if lvl.order|stringformat:'i' == i %}{{ lvl.title }}{% endif %}{% endfor %}{% if not t.levels.all %}{% if i == '1' %}–ù–∞—á–∞–ª—å–Ω—ã–π{% elif i == '2' %}–î–æ–ø—É—Å—Ç–∏–º—ã–π{% else %}–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π{% endif %}{% endif %}"
                                                class="w-full px-4 py-3 bg-gray-50 border border-gray-100 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-green focus:bg-white transition-all font-bold text-gray-800">
                                        </div>

                                        <!-- –ü–æ–ª–∑—É–Ω–æ–∫ % -->
                                        <div>
                                            <div class="flex items-center justify-between mb-3">
                                                <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1">–ü–æ—Ä–æ–≥ (Max %)</label>
                                                <span class="text-[10px] font-black text-brand-green bg-brand-green/5 px-2 py-0.5 rounded-md">
                                                    <span data-range-value="{{ i }}">
                                                        {% for lvl in t.levels.all %}{% if lvl.order|stringformat:"i" == i %}{{ lvl.max_percent }}{% endif %}{% endfor %}
                                                        {% if not t.levels.all %}{% if i == '1' %}30{% elif i == '2' %}59{% else %}100{% endif %}{% endif %}
                                                    </span>%
                                                </span>
                                            </div>
                                            <input type="range" min="0" max="100" name="level_{{ i }}_max"
                                                class="range range-success range-xs" data-range-level="{{ i }}"
                                                {% if i == '3' %}disabled value="100"{% else %}
                                                value="{% for lvl in t.levels.all %}{% if lvl.order|stringformat:'i' == i %}{{ lvl.max_percent }}{% endif %}{% endfor %}{% if not t.levels.all %}{% if i == '1' %}30{% else %}59{% endif %}{% endif %}"
                                                {% endif %}>
                                        </div>

                                        <!-- –û–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è -->
                                        <div class="form-control">
                                            <label class="block text-[10px] font-black text-gray-400 uppercase tracking-widest mb-2 ml-1">–û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞</label>
                                            <textarea name="level_{{ i }}_description" required
                                                placeholder="–ß—Ç–æ –∑–Ω–∞—á–∏—Ç —ç—Ç–æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç?"
                                                class="w-full px-4 py-3 bg-gray-50 border border-gray-100 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-green focus:bg-white transition-all font-medium text-gray-700 resize-none h-24">{% for lvl in t.levels.all %}{% if lvl.order|stringformat:"i" == i %}{{ lvl.description }}{% endif %}{% endfor %}</textarea>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}

                            </div>

                            <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–û—Ç–¥–µ–ª—å–Ω—ã–π –±–ª–æ–∫) -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                {% for i in "123" %}
                                <div class="form-control bg-gray-50/50 p-4 rounded-2xl border border-gray-100">
                                    <label class="block text-[9px] font-black text-gray-400 uppercase tracking-[0.2em] mb-3 ml-1 flex items-center gap-2">
                                        <svg class="w-3 h-3 text-brand-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                        –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ LVL {{ i }}
                                    </label>
                                    <textarea name="level_{{ i }}_recommendations"
                                        class="w-full px-4 py-3 bg-white border border-gray-100 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-green transition-all font-medium text-sm text-gray-600 h-20 resize-none italic"
                                        placeholder="–í–∞—à —Å–æ–≤–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç—É...">{% for lvl in t.levels.all %}{% if lvl.order|stringformat:"i" == i %}{{ lvl.recommendations }}{% endif %}{% endfor %}</textarea>
                                </div>
                                {% endfor %}
                            </div>

                            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                            <div class="flex flex-col sm:flex-row gap-4 justify-end items-center pt-8 border-t border-gray-50">
                                <button type="button"
                                    class="w-full sm:w-auto px-10 py-4 text-gray-400 hover:text-gray-600 font-black rounded-2xl transition-all active:scale-95 text-[10px] uppercase tracking-widest"
                                    onclick="toggleLevelsForm({{ t.id }})">
                                    –û—Ç–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                                </button>

                                <button type="submit"
                                    class="w-full sm:w-auto px-12 py-4 bg-brand-green hover:bg-brand-green-hover text-white font-black rounded-2xl transition-all shadow-xl shadow-brand-green/20 active:scale-95 flex items-center justify-center gap-3 text-xs tracking-widest uppercase">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                                    </svg>
                                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
                                </button>
                            </div>

                        </form>
                    </div>
                </div>

            </div>
            {% endfor %}
        </div>
        {% else %}
        <!-- Empty State -->
        <div class="flex flex-col items-center justify-center py-20 bg-gray-50/50 rounded-[2rem] border-2 border-dashed border-gray-200 px-6 text-center">
            <div class="w-20 h-20 bg-white rounded-3xl shadow-lg flex items-center justify-center text-4xl mb-6">üìâ</div>
            <h3 class="text-xl font-black text-gray-800 mb-2">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</h3>
            <p class="text-gray-400 font-medium max-w-sm mb-8">–°–æ–∑–¥–∞–π—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–µ—Å—Ç, —á—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–ª—è –Ω–µ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø–æ—Ä–æ–≥–∏ –æ—Ü–µ–Ω–æ–∫.</p>
        </div>
        {% endif %}
    </div>
</div>
<script>
    function toggleLevelsForm(testId) {
        const wrapper = document.getElementById(`levelsForm_${testId}`);
        if (!wrapper) return;

        if (wrapper.style.gridTemplateRows === "1fr") {
            wrapper.style.gridTemplateRows = "0fr";
        } else {
            wrapper.style.gridTemplateRows = "1fr";
            // –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–º–µ–Ω–Ω–æ –∫ —ç—Ç–æ–π —Ñ–æ—Ä–º–µ
            bindLevelRanges(wrapper);
        }
    }

    function bindLevelRanges(root) {
        if (!root) return;

        const range1 = root.querySelector('input[data-range-level="1"]');
        const range2 = root.querySelector('input[data-range-level="2"]');

        // –≠–ª–µ–º–µ–Ω—Ç—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
        const labels = {
            min2: root.querySelector('[data-min-label="2"]'),
            min3: root.querySelector('[data-min-label="3"]'),
            val1: root.querySelector('[data-range-value="1"]'),
            val2: root.querySelector('[data-range-value="2"]'),
            max1: root.querySelector('[data-max-label="1"]'),
            max2: root.querySelector('[data-max-label="2"]')
        };

        function updateValues(triggeredBy) {
            let v1 = parseInt(range1.value);
            let v2 = parseInt(range2.value);

            // –õ–æ–≥–∏–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
            if (triggeredBy === 1) {
                // –ï—Å–ª–∏ –¥–≤–∏–≥–∞–µ–º –ø–µ—Ä–≤—ã–π –ø–æ–ª–∑—É–Ω–æ–∫
                if (v1 >= 99) v1 = 98; // –æ—Å—Ç–∞–≤–ª—è–µ–º –º–µ—Å—Ç–æ –¥–ª—è 2 –∏ 3 —É—Ä–æ–≤–Ω–µ–π
                if (v1 >= v2) {
                    v2 = v1 + 1; // —Ç–æ–ª–∫–∞–µ–º –≤—Ç–æ—Ä–æ–π –≤–ø–µ—Ä–µ–¥
                }
            } else if (triggeredBy === 2) {
                // –ï—Å–ª–∏ –¥–≤–∏–≥–∞–µ–º –≤—Ç–æ—Ä–æ–π –ø–æ–ª–∑—É–Ω–æ–∫
                if (v2 <= 1) v2 = 2; // –æ—Å—Ç–∞–≤–ª—è–µ–º –º–µ—Å—Ç–æ –¥–ª—è 1 —É—Ä–æ–≤–Ω—è
                if (v2 >= 100) v2 = 99; // –æ—Å—Ç–∞–≤–ª—è–µ–º –º–µ—Å—Ç–æ –¥–ª—è 3 —É—Ä–æ–≤–Ω—è (–æ–Ω –≤—Å–µ–≥–¥–∞ 100)
                if (v2 <= v1) {
                    v1 = v2 - 1; // —Ç–æ–ª–∫–∞–µ–º –ø–µ—Ä–≤—ã–π –Ω–∞–∑–∞–¥
                }
            }

            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª–∑—É–Ω–∫–æ–≤ —Å –ª–æ–≥–∏–∫–æ–π
            range1.value = v1;
            range2.value = v2;

            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –º–µ—Ç–∫–∏
            if (labels.val1) labels.val1.textContent = v1;
            if (labels.max1) labels.max1.textContent = v1;

            if (labels.min2) labels.min2.textContent = v1 + 1;
            if (labels.val2) labels.val2.textContent = v2;
            if (labels.max2) labels.max2.textContent = v2;

            if (labels.min3) labels.min3.textContent = v2 + 1;
        }

        // –°–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π
        range1.oninput = () => updateValues(1);
        range2.oninput = () => updateValues(2);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
        updateValues(1);
    }

    // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –æ—Ç–∫—Ä—ã—Ç—ã–µ —Ñ–æ—Ä–º—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('[id^="levelsForm_"]').forEach(form => {
            if (form.style.gridTemplateRows === "1fr") {
                bindLevelRanges(form);
            }
        });
    });
</script>